<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Dziedziny ≈ºycia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f4f4f5;
      color: #111827;
    }
    .app-bar {
      background: #111827;
      color: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .app-bar h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    .app-bar button {
      background: transparent;
      border: none;
      color: white;
      font-size: 18px;
      padding: 4px 6px;
    }
    .app-bar button:active {
      transform: scale(0.95);
    }
    .container {
      padding: 12px 16px 16px;
    }
    .breadcrumbs {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
      min-height: 18px;
      white-space: nowrap;
      overflow-x: auto;
    }
    .hint {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 10px;
    }
    .list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 2px 6px rgba(15,23,42,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .card-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }
    .card-header-line {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
    }
    .card-title {
      font-weight: 600;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      font-size: 14px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      flex-shrink: 0;
    }
    .card-subtitle {
      font-size: 11px;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #fee2e2;
      color: #b91c1c;
    }
    .card-actions {
      display: flex;
      gap: 4px;
      align-items: center;
      flex-wrap: nowrap;
    }
    button.icon {
      border: none;
      padding: 4px 6px;
      border-radius: 8px;
      font-size: 14px;
      background: #e5e7eb;
      min-width: 28px;
      flex-shrink: 0;
    }
    button.icon:active {
      transform: scale(0.96);
    }
    .primary-btn {
      width: 100%;
      margin-top: 12px;
      padding: 10px;
      font-size: 15px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: white;
    }
    .primary-btn:active {
      transform: scale(0.98);
    }
    .rating-row {
      display: flex;
      gap: 4px;
      align-items: center;
      font-size: 11px;
      color: #6b7280;
      flex-wrap: wrap;
    }
    .rating-label {
      margin-right: 4px;
    }
    .rating-option {
      border-radius: 999px;
      padding: 2px 6px;
      border: 1px solid #d1d5db;
      font-size: 11px;
      background: #f9fafb;
    }
    .rating-option.active {
      background: #111827;
      color: white;
      border-color: #111827;
    }
    .rating-option:active {
      transform: scale(0.96);
    }
  </style>
</head>
<body>
  <div class="app-bar">
    <button id="backBtn" onclick="goBack()" style="visibility:hidden;">‚Üê</button>
    <h1 id="appTitle">Dziedziny ≈ºycia</h1>
  </div>
  <div class="container">
    <div id="breadcrumbs" class="breadcrumbs"></div>
    <p id="hint" class="hint"></p>
    <div id="nodesList" class="list"></div>
    <button class="primary-btn" onclick="addNode()">+ Dodaj kategoriƒô</button>
  </div>

  <script>
    // ---- Dane i pomocnicze ----
    let roots = [];
    let path = []; // lista id od root do aktualnego rodzica

    function loadData() {
      const raw = localStorage.getItem('lifeDomainsTreeV1');
      if (raw) {
        try {
          roots = JSON.parse(raw);
        } catch (e) {
          roots = [];
        }
      } else {
        roots = [];
      }
    }

    function saveData() {
      localStorage.setItem('lifeDomainsTreeV1', JSON.stringify(roots));
    }

    function findNodeById(list, id) {
      for (const node of list) {
        if (node.id === id) return node;
        if (node.children && node.children.length > 0) {
          const found = findNodeById(node.children, id);
          if (found) return found;
        }
      }
      return null;
    }

    function getCurrentListAndParent() {
      let parent = null;
      let list = roots;
      for (const id of path) {
        const n = (parent === null)
          ? roots.find(x => x.id === id)
          : (parent.children || []).find(x => x.id === id);
        if (!n) break;
        parent = n;
        list = parent.children || (parent.children = []);
      }
      return { list, parent };
    }

    function nextOrder(list) {
      if (!list || list.length === 0) return 1;
      return Math.max(...list.map(item => item.order || 0)) + 1;
    }

    // ---- Liczenie statystyk zaniedbania ----
    // selfNeglect ustawiasz tylko w li≈õciach (0-3),
    // effectiveNeglect dla innych = ≈õrednia z effective dzieci.
    // Dodatkowo liczymy ile czerwonych li≈õci (level 3) w ca≈Çym poddrzewie.
    function computeStatsForNode(node, map) {
      const children = node.children || [];
      if (children.length === 0) {
        const self = typeof node.selfNeglect === 'number' ? node.selfNeglect : 0;
        const redLeafs = self >= 3 ? 1 : 0;
        const leafCount = 1;
        const stats = { effective: self, redLeafs, leafCount };
        map[node.id] = stats;
        return stats;
      } else {
        let totalEff = 0;
        let count = 0;
        let redLeafs = 0;
        let leafCount = 0;
        for (const child of children) {
          const cs = computeStatsForNode(child, map);
          totalEff += cs.effective;
          count += 1;
          redLeafs += cs.redLeafs;
          leafCount += cs.leafCount;
        }
        const eff = count > 0 ? totalEff / count : 0;
        const stats = { effective: eff, redLeafs, leafCount };
        map[node.id] = stats;
        return stats;
      }
    }

    function computeAllStats() {
      const map = {};
      for (const node of roots) {
        computeStatsForNode(node, map);
      }
      return map;
    }

    function levelColor(eff) {
      if (eff < 0.5) return '#22c55e';      // zielony
      if (eff < 1.5) return '#eab308';      // ≈º√≥≈Çty
      if (eff < 2.5) return '#f97316';      // pomara≈Ñcz
      return '#ef4444';                     // czerwony
    }

    function levelNameFromEffective(eff) {
      const approx = Math.round(eff);
      const names = ['OK', 'lekko', '≈õrednio', 'mocno'];
      return names[Math.max(0, Math.min(3, approx))];
    }

    // ---- Renderowanie ----
    function render() {
      const { list, parent } = getCurrentListAndParent();
      const statsMap = computeAllStats();

      const backBtn = document.getElementById('backBtn');
      const titleEl = document.getElementById('appTitle');
      const bcEl = document.getElementById('breadcrumbs');
      const hintEl = document.getElementById('hint');
      const listEl = document.getElementById('nodesList');

      // App bar
      if (parent) {
        backBtn.style.visibility = 'visible';
        titleEl.textContent = parent.name;
      } else {
        backBtn.style.visibility = 'hidden';
        titleEl.textContent = 'Dziedziny ≈ºycia';
      }

      // Breadcrumbs
      if (path.length === 0) {
        bcEl.textContent = '';
      } else {
        const names = [];
        let tmpParent = null;
        let currentList = roots;
        for (const id of path) {
          const n = (tmpParent === null)
            ? currentList.find(x => x.id === id)
            : (tmpParent.children || []).find(x => x.id === id);
          if (!n) break;
          names.push(n.name);
          tmpParent = n;
          currentList = tmpParent.children || [];
        }
        bcEl.textContent = names.join(' / ');
      }

      // Hint
      if (!parent) {
        hintEl.textContent = 'Ustawiasz tu g≈Ç√≥wne dziedziny. Kolejno≈õƒá na li≈õcie oznacza wa≈ºno≈õƒá. Poziom zaniedbania ustalasz w najni≈ºszych podkategoriach.';
      } else {
        hintEl.textContent = 'Ta kategoria jest podsumowaniem swoich podkategorii. Poziom zaniedbania mo≈ºesz ustawiƒá tylko w li≈õciach (kategoriach bez podkategorii).';
      }

      listEl.innerHTML = '';

      const sorted = list.slice().sort((a, b) => (a.order || 0) - (b.order || 0));

      if (sorted.length === 0) {
        const p = document.createElement('p');
        p.className = 'hint';
        p.textContent = parent
          ? 'Na razie brak podkategorii. Dodaj pierwszƒÖ, ≈ºeby rozbiƒá tƒô dziedzinƒô na etapy.'
          : 'Na razie brak dziedzin. Dodaj pierwszƒÖ, np. ‚ÄûMatematyka‚Äù, ‚ÄûFizyka‚Äù, ‚ÄûZdrowie‚Äù‚Ä¶';
        listEl.appendChild(p);
        return;
      }

      sorted.forEach(node => {
        const stats = statsMap[node.id] || { effective: 0, redLeafs: 0, leafCount: 0 };
        const isLeaf = !node.children || node.children.length === 0;

        const card = document.createElement('div');
        card.className = 'card';

        const main = document.createElement('div');
        main.className = 'card-main';

        const headerLine = document.createElement('div');
        headerLine.className = 'card-header-line';

        const dot = document.createElement('div');
        dot.className = 'dot';
        dot.style.backgroundColor = levelColor(stats.effective);

        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = node.name;

        headerLine.appendChild(dot);
        headerLine.appendChild(title);

        const subtitle = document.createElement('div');
        subtitle.className = 'card-subtitle';

        if (isLeaf) {
          const lvlName = levelNameFromEffective(stats.effective);
          subtitle.textContent = `Poziom zaniedbania: ${lvlName} (${typeof node.selfNeglect === 'number' ? node.selfNeglect : 0}/3)`;
        } else {
          const lvlName = levelNameFromEffective(stats.effective);
          const avgText = document.createElement('span');
          avgText.textContent = `≈örednie zaniedbanie: ${lvlName} (${stats.effective.toFixed(1)}/3)`;
          subtitle.appendChild(avgText);

          if (stats.redLeafs > 0) {
            const badge = document.createElement('span');
            badge.className = 'badge';
            badge.textContent = `üî• ${stats.redLeafs} czerw. li≈õci`;
            subtitle.appendChild(badge);
          }
        }

        main.appendChild(headerLine);
        main.appendChild(subtitle);

        // rating tylko dla li≈õci
        if (isLeaf) {
          const ratingRow = document.createElement('div');
          ratingRow.className = 'rating-row';

          const label = document.createElement('span');
          label.className = 'rating-label';
          label.textContent = 'Ustaw poziom:';
          ratingRow.appendChild(label);

          const labels = ['0', '1', '2', '3'];
          labels.forEach((text, level) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'rating-option';
            if ((node.selfNeglect || 0) === level) {
              btn.classList.add('active');
            }
            btn.textContent = text;
            btn.onclick = (e) => {
              e.stopPropagation();
              node.selfNeglect = level;
              saveData();
              render();
            };
            ratingRow.appendChild(btn);
          });

          main.appendChild(ratingRow);
        }

        const actions = document.createElement('div');
        actions.className = 'card-actions';

        const upBtn = document.createElement('button');
        upBtn.className = 'icon';
        upBtn.textContent = '‚Üë';
        upBtn.title = 'Wy≈ºej na li≈õcie';
        upBtn.onclick = (e) => {
          e.stopPropagation();
          moveNode(node.id, 'up');
        };

        const downBtn = document.createElement('button');
        downBtn.className = 'icon';
        downBtn.textContent = '‚Üì';
        downBtn.title = 'Ni≈ºej na li≈õcie';
        downBtn.onclick = (e) => {
          e.stopPropagation();
          moveNode(node.id, 'down');
        };

        const renameBtn = document.createElement('button');
        renameBtn.className = 'icon';
        renameBtn.textContent = '‚úé';
        renameBtn.title = 'Zmie≈Ñ nazwƒô';
        renameBtn.onclick = (e) => {
          e.stopPropagation();
          renameNode(node.id);
        };

        const openBtn = document.createElement('button');
        openBtn.className = 'icon';
        openBtn.textContent = '‚Üí';
        openBtn.title = 'Otw√≥rz podkategorie';
        openBtn.onclick = (e) => {
          e.stopPropagation();
          openNode(node.id);
        };

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'icon';
        deleteBtn.textContent = '‚úï';
        deleteBtn.title = 'Usu≈Ñ';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteNode(node.id);
        };

        actions.appendChild(upBtn);
        actions.appendChild(downBtn);
        actions.appendChild(renameBtn);
        actions.appendChild(openBtn);
        actions.appendChild(deleteBtn);

        card.appendChild(main);
        card.appendChild(actions);

        // klikniƒôcie w kartƒô te≈º otwiera podkategorie
        card.onclick = () => openNode(node.id);

        listEl.appendChild(card);
      });
    }

    // ---- Operacje na drzewie ----
    function addNode() {
      const { list } = getCurrentListAndParent();
      const name = prompt('Nazwa kategorii (np. Matematyka, Zdrowie, Sen):');
      if (!name || !name.trim()) return;
      const node = {
        id: Date.now().toString() + Math.random().toString(16).slice(2),
        name: name.trim(),
        order: nextOrder(list),
        selfNeglect: 0,
        children: []
      };
      list.push(node);
      saveData();
      render();
    }

    function deleteNode(id) {
      const { list } = getCurrentListAndParent();
      const node = list.find(n => n.id === id);
      if (!node) return;
      if (!confirm('Na pewno usunƒÖƒá tƒô kategoriƒô wraz z jej podkategoriami?')) return;
      const idx = list.findIndex(n => n.id === id);
      if (idx !== -1) {
        list.splice(idx, 1);
        saveData();
        render();
      }
    }

    function moveNode(id, direction) {
      const { list } = getCurrentListAndParent();
      const sorted = list.slice().sort((a, b) => (a.order || 0) - (b.order || 0));
      const index = sorted.findIndex(n => n.id === id);
      if (index === -1) return;
      let targetIndex = direction === 'up' ? index - 1 : index + 1;
      if (targetIndex < 0 || targetIndex >= sorted.length) return;

      const current = sorted[index];
      const target = sorted[targetIndex];

      const tmp = current.order;
      current.order = target.order;
      target.order = tmp;

      saveData();
      render();
    }

    function renameNode(id) {
      const { list } = getCurrentListAndParent();
      const node = list.find(n => n.id === id);
      if (!node) return;
      const newName = prompt('Nowa nazwa kategorii:', node.name);
      if (!newName || !newName.trim()) return;
      node.name = newName.trim();
      saveData();
      render();
    }

    function openNode(id) {
      // przechodzimy g≈Çƒôbiej w drzewo
      path.push(id);
      render();
    }

    function goBack() {
      if (path.length === 0) return;
      path.pop();
      render();
    }

    // ---- Start ----
    loadData();
    render();
  </script>
</body>
</html>
